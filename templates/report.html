<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Expense Reports</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="p-4">
    <div class="container">
      <h2 class="mb-4 text-center">Monthly & Category Expense Analytics</h2>

      <!-- Login Section (shown when not logged in) -->
      <div class="row g-3 mb-4" id="loginSection">
        <div class="col-md-12">
          <div class="card">
            <div class="card-header">Login</div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">Username</label>
                  <input
                    type="text"
                    class="form-control"
                    id="usernameInput"
                    placeholder="Enter username"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Password</label>
                  <input
                    type="password"
                    class="form-control"
                    id="passwordInput"
                    placeholder="Enter password"
                  />
                </div>
                <div class="col-md-4 d-flex align-items-end">
                  <button class="btn btn-success w-100" id="loginBtn">Login</button>
                </div>
              </div>
              <div id="loginError" class="text-danger mt-2" style="display: none;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Report Controls (shown when logged in) -->
      <div class="row g-3 mb-4" id="reportSection" style="display: none;">
        <div class="col-md-3">
          <label class="form-label">User</label>
          <div class="form-control bg-light" id="userInfo">Not logged in</div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Reporting Month (YYYY-MM)</label>
          <input
            type="text"
            class="form-control"
            id="monthInput"
            placeholder="2025-12"
            value="2025-12"
          />
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button class="btn btn-primary w-100" id="loadBtn">Load Report</button>
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button class="btn btn-secondary w-100" id="logoutBtn">Logout</button>
        </div>
      </div>

      <div class="row g-4">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">Monthly Expense Trend</div>
            <div class="card-body">
              <canvas id="monthlyChart" height="300"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">Category Expense Share</div>
            <div class="card-body">
              <canvas id="categoryChart" height="300"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-4 mt-1">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">Budget Utilization</div>
            <div class="card-body">
              <ul class="list-group" id="budgetList"></ul>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">Next Month Forecast</div>
            <div class="card-body">
              <p class="fs-4 mb-1">
                <span id="forecastValue">--</span> <small>RMB (estimate)</small>
              </p>
              <small class="text-muted" id="forecastMonths"></small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const monthlyCtx = document.getElementById("monthlyChart");
      const categoryCtx = document.getElementById("categoryChart");
      let monthlyChartInstance = null;
      let categoryChartInstance = null;

      // Token management with localStorage
      function getToken() {
        return localStorage.getItem("expense_tracker_token");
      }

      function saveToken(token) {
        localStorage.setItem("expense_tracker_token", token);
      }

      function clearToken() {
        localStorage.removeItem("expense_tracker_token");
      }

      function showLoginSection() {
        document.getElementById("loginSection").style.display = "block";
        document.getElementById("reportSection").style.display = "none";
      }

      function showReportSection() {
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("reportSection").style.display = "block";
      }

      // Check if user is already logged in
      window.addEventListener("DOMContentLoaded", () => {
        const token = getToken();
        if (token) {
          // Verify token is still valid by making a test request
          fetch("/report/monthly", {
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          })
            .then((response) => {
              if (response.ok) {
                showReportSection();
                document.getElementById("userInfo").textContent = "Logged in";
              } else {
                clearToken();
                showLoginSection();
              }
            })
            .catch(() => {
              clearToken();
              showLoginSection();
            });
        } else {
          showLoginSection();
        }
      });

      // Login function
      async function handleLogin() {
        const username = document.getElementById("usernameInput").value.trim();
        const password = document.getElementById("passwordInput").value.trim();
        const errorDiv = document.getElementById("loginError");

        if (!username || !password) {
          errorDiv.textContent = "Please enter both username and password";
          errorDiv.style.display = "block";
          return;
        }

        try {
          const response = await fetch("/login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ username, password }),
          });

          const data = await response.json();

          if (response.ok && data.token) {
            saveToken(data.token);
            errorDiv.style.display = "none";
            document.getElementById("userInfo").textContent = `Logged in as: ${username}`;
            showReportSection();
            // Auto-load current month report
            loadReports();
          } else {
            errorDiv.textContent = data.message || "Login failed";
            errorDiv.style.display = "block";
          }
        } catch (error) {
          errorDiv.textContent = "Login failed: " + error.message;
          errorDiv.style.display = "block";
        }
      }

      // Logout function
      function handleLogout() {
        clearToken();
        showLoginSection();
        document.getElementById("usernameInput").value = "";
        document.getElementById("passwordInput").value = "";
        document.getElementById("loginError").style.display = "none";
        // Clear charts
        if (monthlyChartInstance) {
          monthlyChartInstance.destroy();
          monthlyChartInstance = null;
        }
        if (categoryChartInstance) {
          categoryChartInstance.destroy();
          categoryChartInstance = null;
        }
        document.getElementById("budgetList").innerHTML = "";
        document.getElementById("forecastValue").textContent = "--";
        document.getElementById("forecastMonths").textContent = "";
      }

      async function authorizedFetch(url, token) {
        const response = await fetch(url, {
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
        });
        if (!response.ok) {
          if (response.status === 401) {
            // Token expired, logout
            handleLogout();
            throw new Error("Session expired. Please login again.");
          }
          const message = await response.text();
          throw new Error(message || "Request failed");
        }
        return response.json();
      }

      function renderMonthlyChart(data) {
        const labels = data.map((item) => item.month);
        const values = data.map((item) => item.total_expense);
        if (monthlyChartInstance) {
          monthlyChartInstance.destroy();
        }
        monthlyChartInstance = new Chart(monthlyCtx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Monthly Expense (RMB)",
                data: values,
                borderColor: "rgb(75, 192, 192)",
                tension: 0.3,
                fill: false,
              },
            ],
          },
        });
      }

      function renderCategoryChart(data) {
        const labels = data.map((item) => item.category);
        const values = data.map((item) => item.total_expense);
        if (categoryChartInstance) {
          categoryChartInstance.destroy();
        }
        categoryChartInstance = new Chart(categoryCtx, {
          type: "pie",
          data: {
            labels,
            datasets: [
              {
                label: "Category Expense",
                data: values,
                backgroundColor: [
                  "#f94144",
                  "#f3722c",
                  "#f8961e",
                  "#f9c74f",
                  "#90be6d",
                  "#43aa8b",
                  "#577590",
                ],
              },
            ],
          },
        });
      }

      function renderBudgetList(data) {
        const list = document.getElementById("budgetList");
        list.innerHTML = "";
        if (!data.length) {
          list.innerHTML =
            '<li class="list-group-item text-muted">No budgets found</li>';
          return;
        }
        data.forEach((item) => {
          const alertIcon = item.used_percent >= 90 ? " ðŸ””" : "";
          const percentClass =
            item.used_percent >= 90 ? "text-danger fw-bold" : "text-success";
          const li = document.createElement("li");
          li.className =
            "list-group-item d-flex justify-content-between align-items-center";
          li.innerHTML = `
            <div>
              <strong>${item.category || "Unknown"}</strong>
              <div class="small text-muted">
                Limit: ${item.limit_amount} | Spent: ${item.spent}
              </div>
            </div>
            <span class="${percentClass}">
              ${item.used_percent}%${alertIcon}
            </span>
          `;
          list.appendChild(li);
        });
      }

      function renderForecast(data) {
        document.getElementById("forecastValue").textContent =
          data?.predicted_next ?? "--";
        document.getElementById("forecastMonths").textContent = data?.months
          ? `Based on months: ${data.months.join(", ")}`
          : "";
      }

      async function loadReports() {
        const token = getToken();
        if (!token) {
          alert("Please login first.");
          showLoginSection();
          return;
        }

        const month = document.getElementById("monthInput").value.trim();
        if (!month) {
          alert("Please provide a reporting month.");
          return;
        }

        try {
          const [monthlyData, categoryData, budgetData, forecastData] =
            await Promise.all([
              authorizedFetch("/report/monthly", token),
              authorizedFetch("/report/category", token),
              authorizedFetch(`/budget/status?month=${encodeURIComponent(month)}`, token),
              authorizedFetch("/predict", token),
            ]);
          renderMonthlyChart(monthlyData);
          renderCategoryChart(categoryData);
          renderBudgetList(budgetData);
          renderForecast(forecastData);
        } catch (error) {
          console.error(error);
          alert("Failed to load report: " + error.message);
        }
      }

      // Event listeners
      document.getElementById("loginBtn").addEventListener("click", handleLogin);
      document.getElementById("logoutBtn").addEventListener("click", handleLogout);
      document.getElementById("loadBtn").addEventListener("click", loadReports);

      // Allow Enter key to submit login
      document.getElementById("passwordInput").addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          handleLogin();
        }
      });
    </script>
  </body>
</html>
